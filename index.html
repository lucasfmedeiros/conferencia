<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/png" href="/favicon.png"/>
    <title>Conferência de Pedidos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center; /* Centraliza o conteúdo */
        }
        h1 {
            font-size: 24px;
        }
        input {
            padding: 10px;
            margin-right: 10px;
        }
        button {
            padding: 10px;
            margin-right: 10px;
            margin-top: 20px; /* Move os botões para cima */
        }
        .dropdown select {
            font-size: 28px; /* Tamanho da fonte desejado */
         }

        button.selected {
            background-color: lightblue; /* Marca o botão selecionado */
        }
        ul {
            list-style-type: none;
            padding: 0;
            text-align: left; /* Alinha a lista à esquerda */
            display: inline-block; /* Centraliza a lista */
        }
        li {
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .nao-listado {
            color: red;
        }
        .controls {
            margin-bottom: 20px; /* Adiciona espaço abaixo dos controles */
        }
    </style>
</head>
<body>
    <h1>Conferência de Pedidos</h1>
    <div class="controls">
        <input type="text" id="nome-input" placeholder="Digite seu nome" required>
        <input type="date" id="data-input">
        <input type="text" id="item-input" placeholder="Digite um código" onkeydown="verificarTecla(event)" disabled>
        <button onclick="verificarItem()">Inserir Manualmente</button>
        <button onclick="gerarCSV()">Enviar Conferência</button>
    </div>
    <div class="dropdown list">
        <select id="select-cidade" onchange="atualizarAba(this.value)">
            <option value="Niteroi" selected>Niteroi</option>
            <option value="Rio de Janeiro">Rio de Janeiro</option>
            <option value="SaoGoncalo">São Gonçalo</option>
        </select>
    </div>
    <ul id="result-list"></ul>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script>
        let abaAtual = 'Niteroi'; // Define a aba padrão ao iniciar a página
        const SHEET_ID = '1xJR50ekmwsZ1F2aCGqujaPvCZsW-iquWuyVPGyIg01o';
        const API_KEY = 'AIzaSyAEYoX7AH_0ZjCU7utv8JND73qAOdLSG3Q';
        let RANGE = 'Niteroi!A:C'; // Ajuste o range conforme necessário
        let itemsList = [];
        let checkedItems = new Set(); // Set para armazenar itens verificados
        let checkedItemsArray = []; // Array para armazenar itens verificados em ordem

        function atualizarAba(aba) {
            abaAtual = aba;
            RANGE = `${aba}!A:C`;
            itemsList = []; // Limpa a lista de itens para forçar atualização na próxima verificação
            checkedItems.clear(); // Limpa o Set de itens verificados
        }

        document.getElementById('nome-input').addEventListener('input', function() {
            const nome = this.value.trim();
            const itemInput = document.getElementById('item-input');
            itemInput.disabled = nome === ''; // Habilitar o campo de código apenas se o campo de nome estiver preenchido
        });

        function verificarItem() {
            const nomeInput = document.getElementById('nome-input');
            const itemInput = document.getElementById('item-input');
            const nome = nomeInput.value.trim();
            const item = itemInput.value.trim();
            if (!nome || !item.match(/^\d+$/)) {
                alert("Por favor, preencha o nome e insira apenas números no campo de item.");
                return;
            }

            if (checkedItems.has(item)) {
                alert("Este código já foi verificado.");
                itemInput.value = ''; // Limpa a caixa de digitação
                return;
            }

            if (itemsList.length === 0) {
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`)
                .then(response => response.json())
                .then(data => {
                    itemsList = data.values ? data.values.flat() : [];
                    verificarItemContinua(nome, item);
                })
                .catch(error => {
                    console.error('Erro ao carregar lista de itens:', error);
                });
            } else {
                verificarItemContinua(nome, item);
            }
        }

        function verificarItemContinua(nome, item) {
            const resultList = document.getElementById('result-list');
            const listItem = document.createElement('li');
            if (itemsList.includes(item)) {
                listItem.textContent = `${item} - Encontrado`;
            } else {
                listItem.textContent = `${item} - Não encontrado`;
                listItem.classList.add('nao-listado');
            }
            resultList.appendChild(listItem);
            checkedItems.add(item); // Adiciona o item ao Set de itens verificados
            checkedItemsArray.push({ nome, item, status: listItem.textContent.split(' - ')[1] }); // Adiciona o item ao Array
            document.getElementById('item-input').value = ''; // Limpa a caixa de digitação
        }

        function gerarCSV() {
            if (checkedItemsArray.length === 0) {
                alert("Não há itens para gerar o CSV.");
                return;
            }

            const nome = document.getElementById('nome-input').value.trim();
            const data = document.getElementById('data-input').value;
            const header = ["Nome", "Data", "Aba", "Item", "Status"];
            const rows = checkedItemsArray.map(e => [nome, data, abaAtual, e.item, e.status]);
            const csvContent = [header, ...rows].map(e => e.join(",")).join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "itens_verificados.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            enviarArquivoTelegram(csvContent);
        }

        function enviarArquivoTelegram(csvContent) {
            const formData = new FormData();
            const blob = new Blob([csvContent], { type: 'text/csv' });
            formData.append('chat_id', '-4200936402'); // Substitua pelo ID do chat desejado
            formData.append('document', blob, 'itens_verificados.csv');

            fetch(`https://api.telegram.org/bot7272225151:AAFyfJNQOfHt-1YCo0HH8kKwrFpwBLyn9kk/sendDocument`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao enviar documento via Telegram');
                }
                console.log('Documento enviado via Telegram com sucesso!');
                alert("CSV enviado com sucesso!");
                // Limpar a lista de itens verificados após o envio bem-sucedido
                const resultList = document.getElementById('result-list');
                resultList.innerHTML = '';
                checkedItemsArray = [];
            })
            .catch(error => {
                console.error('Erro ao enviar documento via Telegram:', error);
                alert("Erro ao enviar CSV via Telegram.");
            });

            enviarMensagemTelegram();
        }

        function enviarMensagemTelegram() {
            const nome = document.getElementById('nome-input').value.trim();
            const data = document.getElementById('data-input').value;
            const aba = abaAtual;
            const status = "Sucesso";
            let mensagem = `Nome: ${nome}\nData: ${data}\nAba: ${aba}\nStatus: ${status}`;
            fetch(`https://api.telegram.org/bot7272225151:AAFyfJNQOfHt-1YCo0HH8kKwrFpwBLyn9kk/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_id: '-4200936402',
                    text: mensagem
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao enviar mensagem via Telegram');
                }
                console.log('Mensagem enviada via Telegram com sucesso!');
            })
            .catch(error => {
                console.error('Erro ao enviar mensagem via Telegram:', error);
            });
        }

        function verificarTecla(event) {
            if (event.key === "Enter") {
                verificarItem();
            }
        }

        function atualizarAba(aba) {
            document.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
            abaAtual = aba;
            RANGE = `${aba}!A:C`;
            itemsList = []; // Limpa a lista de itens para forçar atualização na próxima verificação
            checkedItems.clear(); // Limpa o Set de itens verificados
            document.getElementById(`btn${aba.replace(/\s/g, '')}`).classList.add('selected');
        }
    </script>
</body>
</html>
